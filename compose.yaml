version: "3"

services:
  front-envoy:
    image: docker.io/envoyproxy/envoy:v1.28-latest
    volumes:
      - ./run/config/envoy.yaml:/envoy.yaml
    depends_on:
      podinfo:
        condition: service_healthy
    command:
      - -c
      - /envoy.yaml
    network_mode: host
    ports:
      - "${PORT_PROXY:-8000}:8000"

  dex:
    image: ghcr.io/dexidp/dex:latest
    volumes:
      - ./run/config/dex.yaml:/dex.yaml
    ports:
      - "${PORT_DEX:-5556}:5556"
    network_mode: host
    command:
      - dex
      - serve
      - /dex.yaml

  opa:
    image: docker.io/openpolicyagent/opa:latest-envoy-static
    volumes:
      - ./run/config/policy.rego:/policies/policy.rego
    ports:
      - "${PORT_OPA:-9191}:9191"
    command:
      - run
      - --server
      - --log-level=debug
      - --set=plugins.envoy_ext_authz_grpc.addr=:9191
      - --set=plugins.envoy_ext_authz_grpc.path=envoy/authz/allow
      - --set=decision_logs.console=true
      - --set=status.console=true
      - --ignore=.*
      - /policies/policy.rego
    network_mode: host

  otel:
    image: docker.io/otel/opentelemetry-collector-contrib
    volumes:
      - ./run/config/otel.yaml:/etc/otel/config.yaml
    ports:
      - "${PORT_OTEL:-4317}:4317"
    network_mode: host

  podinfo:
    image: ghcr.io/stefanprodan/podinfo
    network_mode: host
